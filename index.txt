<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>黄の转换器 ・ 5'-(密码子)-3'</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        body {
            background: linear-gradient(145deg, #e3f0f5 0%, #d4e3ed 100%);
            min-height: 100vh;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .tool-container {
            max-width: 1100px;
            width: 100%;
            background: rgba(255,255,255,0.75);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 48px;
            padding: 32px 36px;
            box-shadow: 0 30px 50px rgba(18, 52, 77, 0.25), 0 10px 20px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.6);
        }

        h1 {
            font-size: 2.2rem;
            font-weight: 600;
            margin: 0 0 8px 0;
            letter-spacing: -0.02em;
            color: #0f344b;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        h1 span {
            background: #1f5577;
            color: white;
            font-size: 0.9rem;
            font-weight: 500;
            padding: 5px 14px;
            border-radius: 60px;
            margin-left: 12px;
        }
        .subhead {
            color: #2f5575;
            margin-bottom: 30px;
            font-size: 1rem;
            border-left: 4px solid #4982aa;
            padding-left: 20px;
            background: rgba(73, 130, 170, 0.1);
            border-radius: 0 100px 100px 0;
        }

        .double-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 28px;
            margin-top: 10px;
        }
        @media (max-width: 700px) {
            .double-panel {
                grid-template-columns: 1fr;
                gap: 36px;
            }
            .tool-container { padding: 22px; }
        }

        .io-card {
            background: white;
            border-radius: 32px;
            padding: 24px 22px;
            box-shadow: 0 12px 24px -8px rgba(19, 59, 87, 0.2);
            border: 1px solid rgba(255,255,255,0.8);
            transition: all 0.15s;
            display: flex;
            flex-direction: column;
        }
        .io-card:hover {
            box-shadow: 0 18px 32px -8px #1d4f73a0;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            font-weight: 500;
        }
        .card-header .title {
            background: #eef4fa;
            padding: 6px 18px;
            border-radius: 40px;
            font-size: 1.2rem;
            color: #123f5f;
            border: 1px solid #bed9ef;
        }
        .card-header .badge {
            background: none;
            font-size: 0.9rem;
            color: #3b6f94;
        }

        .main-input {
            width: 100%;
            height: 200px;
            padding: 18px;
            font-size: 1rem;
            font-family: 'JetBrains Mono', 'Fira Code', 'Cascadia Code', monospace;
            background: #f3f9ff;
            border: 2px solid #c6ddef;
            border-radius: 22px;
            resize: vertical;
            outline: none;
            transition: 0.2s;
            color: #032436;
            line-height: 1.5;
            margin-bottom: 16px;
            box-shadow: inset 0 3px 6px rgba(0,0,0,0.02);
        }
        .main-input:focus {
            border-color: #3174a0;
            background: #ffffff;
            box-shadow: 0 0 0 4px rgba(57, 128, 177, 0.2), inset 0 2px 4px #cbdbe9;
        }

        .button-strip {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin: 12px 0 8px 0;
            align-items: center;
        }
        .btn {
            background: white;
            border: 1.5px solid #b0cde0;
            padding: 10px 20px;
            border-radius: 50px;
            font-weight: 550;
            font-size: 0.9rem;
            color: #1b4565;
            cursor: pointer;
            transition: 0.12s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 3px 5px rgba(0,0,0,0.02);
            letter-spacing: 0.3px;
        }
        .btn:hover {
            background: #e2effb;
            border-color: #4083b0;
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -5px #2b5f88a0;
        }
        .btn.primary {
            background: #1e5380;
            border-color: #1e5380;
            color: white;
        }
        .btn.primary:hover {
            background: #26699f;
            border-color: #1d5e90;
        }

        .clipboard-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 8px;
            border-top: 1px dashed #aec9e0;
            padding-top: 14px;
            justify-content: flex-start;
        }

        .small-hint {
            font-size: 0.75rem;
            color: #3f6c91;
            background: #d7e8fa;
            padding: 4px 12px;
            border-radius: 40px;
            display: inline-block;
            margin-left: auto;
        }

        .status-line {
            font-size: 0.8rem;
            color: #22638b;
            margin-top: 6px;
            min-height: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .status-line span {
            background: #e1effb;
            padding: 2px 10px;
            border-radius: 30px;
        }

        .footer-note {
            margin-top: 32px;
            text-align: center;
            color: #2b5f7a;
            font-size: 0.85rem;
            background: #ebf4fc;
            padding: 12px 24px;
            border-radius: 60px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }
        .clear-all-btn {
            background: transparent;
            border: 1.5px solid #8fb7d3;
            padding: 8px 24px;
            border-radius: 40px;
            color: #164a6b;
            font-weight: 500;
            cursor: pointer;
            transition: 0.1s;
        }
        .clear-all-btn:hover {
            background: #ffffffb8;
            border-color: #5b92bc;
        }
        .error-flash {
            animation: errorShake 0.2s 2 ease;
        }
        @keyframes errorShake {
            0% { transform: translateX(0); }
            25% { transform: translateX(6px); }
            75% { transform: translateX(-6px); }
            100% { transform: translateX(0); }
        }
        .format-tag {
            font-family: monospace;
            background: #1d4560;
            color: white;
            padding: 3px 10px;
            border-radius: 30px;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
<div class="tool-container">
    <h1>
        ? 文本 ? 密码子 (5'-3')
        <span>AUCG + 随机填充</span>
    </h1>
    <div class="subhead">左侧文本 → Base64（等号→随机碱基）→ 右侧密码子 ・ 右侧按碱基数模3恢复等号</div>

    <div class="double-panel">
        <!-- 左侧：纯文本输入框 -->
        <div class="io-card" id="leftCard">
            <div class="card-header">
                <div class="title">? 纯文本</div>
                <div class="badge">UTF-8</div>
            </div>
            <textarea id="textInput" class="main-input" placeholder="输入任意文本..."></textarea>
            
            <div class="button-strip">
                <button class="btn primary" id="encodeBtn">?? 转成密码子</button>
                <button class="btn" id="clearTextBtn">? 清空</button>
                <span class="small-hint">字符数 <span id="textCharCount">0</span></span>
            </div>
        </div>

        <!-- 右侧：密码子输入框 (带5'/3'标识) -->
        <div class="io-card" id="rightCard">
            <div class="card-header">
                <div class="title">? 密码子 (5'-3')</div>
                <div class="badge">A/U/C/G</div>
            </div>
            <textarea id="codonInput" class="main-input" placeholder="例如：AAACCCUUG... 仅大写AUCG (含随机填充)"></textarea>
            
            <div class="button-strip">
                <button class="btn primary" id="decodeBtn">?? 转成文字</button>
                <button class="btn" id="clearCodonBtn">? 清空</button>
                <span class="small-hint">长度 <span id="codonCharCount">0</span></span>
            </div>

            <!-- 专属复制/粘贴按钮行 (右侧) -->
            <div class="clipboard-row">
                <button class="btn" id="copyCodonBtn" title="复制右侧密码子内容">? 复制</button>
                <button class="btn" id="pasteCodonBtn" title="粘贴到右侧密码子框">? 粘贴</button>
                <span style="flex:1; text-align:right; font-size:0.75rem; color:#3d6f94;">授权粘贴</span>
            </div>
        </div>
    </div>

    <div class="footer-note">
        <button class="clear-all-btn" id="clearAllBtn">? 清空两个输入框</button>
        <span class="format-tag">5'-(AUCG...)-3'</span>
    </div>
</div>

<script>
    (function() {
        // ---------- 固定密码子映射 (与原来完全一致) ----------
        const codonMap = {
            'A':'AAA','B':'AAC','C':'AAG','D':'AAU','E':'ACA','F':'ACC','G':'ACG','H':'ACU','I':'AGA','J':'AGC','K':'AGG','L':'AGU','M':'AUA','N':'AUC','O':'AUG','P':'AUU','Q':'CAA','R':'CAC','S':'CAG','T':'CAU','U':'CCA','V':'CCC','W':'CCG','X':'CCU','Y':'CGA','Z':'CGC',
            'a':'CGG','b':'CGU','c':'CUA','d':'CUC','e':'CUG','f':'CUU','g':'GAA','h':'GAC','i':'GAG','j':'GAU','k':'GCA','l':'GCC','m':'GCG','n':'GCU','o':'GGA','p':'GGC','q':'GGG','r':'GGU','s':'GUA','t':'GUC','u':'GUG','v':'GUU','w':'UAA','x':'UAC','y':'UAG','z':'UAU',
            '0':'UCA','1':'UCC','2':'UCG','3':'UCU','4':'UGA','5':'UGC','6':'UGG','7':'UGU','8':'UUA','9':'UUC','+':'UUG','/':'UUU'
        };

        const reverseCodonMap = {};
        for (const [base64Char, codon] of Object.entries(codonMap)) {
            reverseCodonMap[codon] = base64Char;
        }

        // 随机碱基生成器 (A,U,C,G)
        function randomBase() {
            const bases = ['A', 'U', 'C', 'G'];
            return bases[Math.floor(Math.random() * 4)];
        }

        // ---------- DOM 元素 ----------
        const textInput = document.getElementById('textInput');
        const codonInput = document.getElementById('codonInput');
        const encodeBtn = document.getElementById('encodeBtn');
        const decodeBtn = document.getElementById('decodeBtn');
        const clearTextBtn = document.getElementById('clearTextBtn');
        const clearCodonBtn = document.getElementById('clearCodonBtn');
        const copyCodonBtn = document.getElementById('copyCodonBtn');
        const pasteCodonBtn = document.getElementById('pasteCodonBtn');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const textCharCount = document.getElementById('textCharCount');
        const codonCharCount = document.getElementById('codonCharCount');

        // ---------- 辅助函数 ----------
        function updateCounts() {
            textCharCount.textContent = textInput.value.length;
            codonCharCount.textContent = codonInput.value.length;
        }

        function shakeElement(element) {
            element.classList.add('error-flash');
            setTimeout(() => element.classList.remove('error-flash'), 500);
        }

        // ========== 编码: 文本 -> Base64 (处理等号) -> 密码子 (添加5'/3'包装) ==========
        function encodeTextToCodon() {
            const rawText = textInput.value;
            if (rawText === '') {
                codonInput.value = '';
                updateCounts();
                return;
            }

            try {
                // 1. 文本 -> UTF-8字节 -> Base64
                const utf8Bytes = new TextEncoder().encode(rawText);
                let binary = '';
                for (let i = 0; i < utf8Bytes.length; i++) {
                    binary += String.fromCharCode(utf8Bytes[i]);
                }
                let base64Str = btoa(binary);  // 可能包含一个或两个等号

                // 2. 记住等号数量，并移除等号 (用随机碱基代替)
                let equalSignCount = 0;
                if (base64Str.endsWith('==')) {
                    equalSignCount = 2;
                    base64Str = base64Str.slice(0, -2); // 去掉两个等号
                } else if (base64Str.endsWith('=')) {
                    equalSignCount = 1;
                    base64Str = base64Str.slice(0, -1); // 去掉一个等号
                }

                // 3. 将Base64每个字符(不含等号)转为密码子三联体
                let codonResult = '';
                for (let i = 0; i < base64Str.length; i++) {
                    const ch = base64Str[i];
                    const codon = codonMap[ch];
                    if (!codon) {
                        throw new Error(`无效Base64字符: ${ch}`);
                    }
                    codonResult += codon;
                }

                // 4. 补上随机碱基：等号数量个随机碱基 (作为填充)
                for (let e = 0; e < equalSignCount; e++) {
                    codonResult += randomBase();
                }

                // 5. 包装成 5'-(...)-3' 格式 (仅展示，解码时自动去除)
                codonInput.value = `5'-${codonResult}-3'`;
            } catch (e) {
                console.warn('编码失败:', e);
                codonInput.value = '[编码错误]';
                shakeElement(document.getElementById('leftCard'));
            }
            updateCounts();
        }

        // ========== 重写解码: 密码子 -> Base64 (根据碱基数模3推断等号) -> 文本 ==========
        function decodeCodonToText() {
            let rawCodon = codonInput.value;
            if (rawCodon.trim() === '') {
                textInput.value = '';
                updateCounts();
                return;
            }

            try {
                // 1. 移除所有空白、换行，同时去掉可选的 5'- 和 -3' 前缀/后缀 (增强鲁棒性)
                let cleaned = rawCodon.replace(/\s+/g, '');
                // 去掉 5'-  (如果存在)
                if (cleaned.startsWith("5'-")) {
                    cleaned = cleaned.substring(3);
                }
                // 去掉 -3' (如果存在)
                if (cleaned.endsWith("-3'")) {
                    cleaned = cleaned.substring(0, cleaned.length - 3);
                }
                // 还可能存在单独的 ' 或 - 等，只保留AUCG
                cleaned = cleaned.replace(/[^AUCG]/gi, ''); 
                cleaned = cleaned.toUpperCase();

                if (cleaned.length === 0) {
                    throw new Error('输入为空或无效');
                }
                if (!/^[AUCG]+$/.test(cleaned)) {
                    throw new Error('密码子只能包含A、U、C、G');
                }

                const totalBases = cleaned.length;          // 碱基总个数
                const remainder = totalBases % 3;            // 碱基数模3 → 决定填充的等号数量
                let paddingBases;  // 填充的碱基个数 p (0,1,2)
                if (remainder === 0) {
                    paddingBases = 0;
                } else if (remainder === 1) {
                    paddingBases = 1;
                } else { // remainder === 2
                    paddingBases = 2;
                }

                // 真实的Base64字符数 (每个字符对应一个三联体)
                const realCodonCount = (totalBases - paddingBases) / 3;  // 一定是整数

                // 2. 提取前 realCodonCount 个三联体，转成base64字符串
                let base64Str = '';
                for (let i = 0; i < realCodonCount; i++) {
                    const triplet = cleaned.substr(i * 3, 3);
                    const base64Char = reverseCodonMap[triplet];
                    if (!base64Char) {
                        throw new Error(`未知的密码子三联体: ${triplet}`);
                    }
                    base64Str += base64Char;
                }

                // 3. 根据 paddingBases 补回等号
                if (paddingBases === 1) {
                    base64Str += '=';
                } else if (paddingBases === 2) {
                    base64Str += '==';
                }

                // 4. Base64解码回文本
                const binary = atob(base64Str);
                const bytes = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) {
                    bytes[i] = binary.charCodeAt(i);
                }
                const decodedText = new TextDecoder().decode(bytes);
                textInput.value = decodedText;
            } catch (e) {
                console.warn('解码失败:', e);
                textInput.value = '[解码失败: ' + e.message + ']';
                shakeElement(document.getElementById('rightCard'));
            }
            updateCounts();
        }

        // 清空左侧文本
        function clearTextOnly() {
            textInput.value = '';
            updateCounts();
        }

        // 清空右侧密码子
        function clearCodonOnly() {
            codonInput.value = '';
            updateCounts();
        }

        // 清空全部
        function clearAll() {
            textInput.value = '';
            codonInput.value = '';
            updateCounts();
        }

        // 复制右侧密码子内容 (保持原始内容，不添加/删除格式)
        async function copyCodon() {
            const content = codonInput.value;
            if (!content) {
                alert('没有可复制的内容');
                return;
            }
            try {
                await navigator.clipboard.writeText(content);
                copyCodonBtn.style.background = '#c7e0b0';
                setTimeout(() => copyCodonBtn.style.background = '', 200);
            } catch (err) {
                alert('复制失败: ' + err.message);
            }
        }

        // 粘贴到右侧密码子框 (允许粘贴带5'/3'格式的文本)
        async function pasteToCodon() {
            try {
                const clipboardText = await navigator.clipboard.readText();
                codonInput.value = clipboardText;
                updateCounts();
            } catch (err) {
                alert('无法粘贴，请确保授予剪贴板权限或手动输入。\n' + err.message);
            }
        }

        // ---------- 事件绑定 ----------
        encodeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            encodeTextToCodon();
        });

        decodeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            decodeCodonToText();
        });

        clearTextBtn.addEventListener('click', (e) => {
            e.preventDefault();
            clearTextOnly();
        });

        clearCodonBtn.addEventListener('click', (e) => {
            e.preventDefault();
            clearCodonOnly();
        });

        copyCodonBtn.addEventListener('click', (e) => {
            e.preventDefault();
            copyCodon();
        });

        pasteCodonBtn.addEventListener('click', (e) => {
            e.preventDefault();
            pasteToCodon();
        });

        clearAllBtn.addEventListener('click', (e) => {
            e.preventDefault();
            clearAll();
        });

        // 实时计数
        textInput.addEventListener('input', updateCounts);
        codonInput.addEventListener('input', updateCounts);

        // 键盘快捷: Ctrl+Enter 触发各自转换
        textInput.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                encodeTextToCodon();
            }
        });
        codonInput.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                decodeCodonToText();
            }
        });

        // 初始计数更新
        updateCounts();
    })();
</script>
</body>
</html>
